{% extends "base.html" %}

{% block title %}Edit Leave Request{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-pencil-square"></i> Edit Leave Request</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>HR Override:</strong> You are editing an existing leave request. 
                        Changes will be logged and employee will be notified.
                    </div>
                    
                    <!-- Current Leave Details -->
                    <div class="alert alert-light">
                        <h6><i class="bi bi-info-circle"></i> Current Leave Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Employee:</strong> {{ leave_request.employee.full_name }}<br>
                                <strong>Employee ID:</strong> {{ leave_request.employee.employee_id }}<br>
                                <strong>Current Type:</strong> {{ leave_request.leave_type.replace('_', ' ').title() }}
                            </div>
                            <div class="col-md-6">
                                <strong>Current Dates:</strong> {{ leave_request.start_date.strftime('%Y-%m-%d') }} to {{ leave_request.end_date.strftime('%Y-%m-%d') }}<br>
                                <strong>Current Days:</strong> {{ leave_request.total_days }} days<br>
                                <strong>Status:</strong> 
                                {% if leave_request.status == 'approved' %}
                                    <span class="badge bg-success">Approved</span>
                                {% elif leave_request.status == 'rejected' %}
                                    <span class="badge bg-danger">Rejected</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('leaves.edit_leave', leave_id=leave_request.id) }}" id="editLeaveForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="leave_type" class="form-label">Leave Type *</label>
                                <select class="form-control" id="leave_type" name="leave_type" required>
                                    <option value="">Select Leave Type</option>
                                    <option value="annual_leave" {{ 'selected' if leave_request.leave_type == 'annual_leave' else '' }}>
                                        Annual Leave (21 days, 2 weeks notice)
                                    </option>
                                    <option value="sick_leave_full" {{ 'selected' if leave_request.leave_type == 'sick_leave_full' else '' }}>
                                        Sick Leave - Full Pay (30 days)
                                    </option>
                                    <option value="sick_leave_half" {{ 'selected' if leave_request.leave_type == 'sick_leave_half' else '' }}>
                                        Sick Leave - Half Pay (15 days)
                                    </option>
                                    <option value="maternity_leave" {{ 'selected' if leave_request.leave_type == 'maternity_leave' else '' }}>
                                        Maternity Leave (90 days, 1 month notice)
                                    </option>
                                    <option value="paternity_leave" {{ 'selected' if leave_request.leave_type == 'paternity_leave' else '' }}>
                                        Paternity Leave (14 days)
                                    </option>
                                    <option value="compassionate_leave" {{ 'selected' if leave_request.leave_type == 'compassionate_leave' else '' }}>
                                        Compassionate Leave (7 days)
                                    </option>
                                    <option value="special_leave" {{ 'selected' if leave_request.leave_type == 'special_leave' else '' }}>
                                        Special Leave (Studies/Exams)
                                    </option>
                                    <option value="unpaid_leave" {{ 'selected' if leave_request.leave_type == 'unpaid_leave' else '' }}>
                                        Unpaid Leave
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Days (Auto-calculated)</label>
                                <input type="text" class="form-control" id="total_days_display" readonly 
                                       value="{{ leave_request.total_days }} days"
                                       style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ leave_request.start_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" 
                                       value="{{ leave_request.end_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason *</label>
                            <textarea class="form-control" id="reason" name="reason" rows="4" required>{{ leave_request.reason }}</textarea>
                            <div class="form-text">Current reason with edit history will be preserved</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-warning me-2">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                                <a href="{{ url_for('leaves.list_leaves') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="button" class="btn btn-danger ms-3" onclick="deleteLeave()">
                                    <i class="bi bi-trash"></i> Delete Request
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate total days when dates change
function calculateDays() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('total_days_display').value = diffDays + ' days';
        } else {
            document.getElementById('total_days_display').value = 'Invalid date range';
        }
    }
}

document.getElementById('start_date').addEventListener('change', calculateDays);
document.getElementById('end_date').addEventListener('change', calculateDays);

// Update end date minimum when start date changes
document.getElementById('start_date').addEventListener('change', function() {
    document.getElementById('end_date').min = this.value;
});

// Set initial minimum dates
document.getElementById('start_date').min = new Date().toISOString().split('T')[0];
document.getElementById('end_date').min = document.getElementById('start_date').value;

// Delete function
function deleteLeave() {
    if (confirm('Are you sure you want to delete this leave request?\n\nThis action cannot be undone and will permanently remove the request from the system.')) {
        window.location.href = "{{ url_for('leaves.delete_leave', leave_id=leave_request.id) }}";
    }
}

// Form validation
document.getElementById('editLeaveForm').addEventListener('submit', function(e) {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    
    if (endDate < startDate) {
        e.preventDefault();
        alert('End date cannot be before start date');
        return false;
    }
    
    if (confirm('Are you sure you want to save these changes to the leave request?')) {
        return true;
    } else {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}