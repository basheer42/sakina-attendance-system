{% extends "base.html" %}

{% block title %}Request Leave{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-calendar-plus"></i> Request Leave</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Sakina Gas Company Leave Policy</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="small mb-0">
                                    <li><strong>Annual Leave:</strong> 21 days per year (apply 2 weeks in advance)</li>
                                    <li><strong>Sick Leave (Full):</strong> 30 days at full pay with certificate</li>
                                    <li><strong>Sick Leave (Half):</strong> 15 days at half pay with certificate</li>
                                    <li><strong>Maternity:</strong> 90 days (apply 1 month in advance)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="small mb-0">
                                    <li><strong>Paternity:</strong> 14 days maximum</li>
                                    <li><strong>Compassionate:</strong> 7 days for close relative's death</li>
                                    <li><strong>Special Leave:</strong> Studies/exams (management approval)</li>
                                    <li><strong>Unpaid Leave:</strong> Deducted from salary</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('leaves.request_leave') }}" id="leaveForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="employee_id" class="form-label">Employee *</label>
                                <select class="form-control" id="employee_id" name="employee_id" required>
                                    <option value="">Select Employee</option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.employee_id }}">
                                        {{ employee.employee_id }} - {{ employee.full_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="leave_type" class="form-label">Leave Type *</label>
                                <select class="form-control" id="leave_type" name="leave_type" required>
                                    <option value="">Select Leave Type</option>
                                    {% for leave_type, info in leave_types_info.items() %}
                                    <option value="{{ leave_type }}" 
                                            data-max-days="{{ info.max_days or 'unlimited' }}"
                                            data-notice-days="{{ info.notice_days or 0 }}"
                                            data-description="{{ info.description }}">
                                        {{ info.display_name }}
                                        {% if info.max_days %}(Max: {{ info.max_days }} days){% endif %}
                                        {% if info.notice_days > 0 %}({{ info.notice_days }} days notice){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text" id="leave_type_info">
                                    Select a leave type to see details and requirements
                                </div>
                            </div>
                        </div>
                        
                        <!-- Leave Type Details Display -->
                        <div class="alert alert-light" id="leave_details" style="display: none;">
                            <h6><i class="bi bi-clipboard-check"></i> Leave Type Requirements</h6>
                            <div id="leave_details_content">
                                <!-- Details will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <div class="form-text" id="start_date_info">
                                    Select leave type first to see minimum notice requirements
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total Days</label>
                            <input type="text" class="form-control" id="total_days" readonly 
                                   style="background-color: #f8f9fa;" placeholder="Select dates to calculate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason *</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" 
                                      placeholder="Please provide a detailed reason for this leave request" required></textarea>
                        </div>
                        
                        <!-- Notice Period Warning -->
                        <div class="alert alert-warning" id="notice_warning" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span id="notice_warning_text">Notice period warning will appear here</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-send"></i> Submit Request
                                </button>
                                <a href="{{ url_for('leaves.list_leaves') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Warning Modal -->
<div class="modal fade" id="warningModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">⚠️ Leave Policy Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="warningContent">
                <!-- Warning content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="proceedAnyway">
                    Proceed Anyway (Requires HR Approval)
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Leave type selection handler
document.getElementById('leave_type').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const leaveDetails = document.getElementById('leave_details');
    const leaveDetailsContent = document.getElementById('leave_details_content');
    const leaveTypeInfo = document.getElementById('leave_type_info');
    const startDateInfo = document.getElementById('start_date_info');
    
    if (selectedOption.value) {
        const maxDays = selectedOption.getAttribute('data-max-days');
        const noticeDays = selectedOption.getAttribute('data-notice-days');
        const description = selectedOption.getAttribute('data-description');
        
        // Show leave details
        leaveDetailsContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Description:</strong> ${description}<br>
                    <strong>Maximum Days:</strong> ${maxDays === 'unlimited' ? 'No limit (management discretion)' : maxDays + ' days'}
                </div>
                <div class="col-md-6">
                    <strong>Notice Required:</strong> ${noticeDays == 0 ? 'Can be immediate' : noticeDays + ' days in advance'}<br>
                    <strong>Approval:</strong> HR Manager required
                </div>
            </div>
        `;
        leaveDetails.style.display = 'block';
        leaveTypeInfo.textContent = description;
        
        // Update minimum start date based on notice period
        updateMinimumStartDate(parseInt(noticeDays));
        
        // Update start date info
        if (noticeDays > 0) {
            const minDate = new Date();
            minDate.setDate(minDate.getDate() + parseInt(noticeDays));
            startDateInfo.textContent = `Minimum start date: ${minDate.toISOString().split('T')[0]} (${noticeDays} days notice required)`;
            startDateInfo.className = 'form-text text-warning';
        } else {
            startDateInfo.textContent = 'Can start immediately';
            startDateInfo.className = 'form-text text-success';
        }
    } else {
        leaveDetails.style.display = 'none';
        leaveTypeInfo.textContent = 'Select a leave type to see details and requirements';
        startDateInfo.textContent = 'Select leave type first to see minimum notice requirements';
        startDateInfo.className = 'form-text';
    }
});

function updateMinimumStartDate(noticeDays) {
    const startDateInput = document.getElementById('start_date');
    const minDate = new Date();
    minDate.setDate(minDate.getDate() + noticeDays);
    startDateInput.min = minDate.toISOString().split('T')[0];
}

// Calculate total days
function calculateDays() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (end >= start) {
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('total_days').value = diffDays + ' days';
            
            // Check if exceeds maximum days for leave type
            checkLeaveTypeLimit(diffDays);
            checkNoticeRequirement();
        } else {
            document.getElementById('total_days').value = 'End date must be after start date';
        }
    } else {
        document.getElementById('total_days').value = '';
    }
}

function checkLeaveTypeLimit(requestedDays) {
    const leaveTypeSelect = document.getElementById('leave_type');
    const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const maxDays = selectedOption.getAttribute('data-max-days');
        const warningDiv = document.getElementById('notice_warning');
        const warningText = document.getElementById('notice_warning_text');
        
        if (maxDays !== 'unlimited' && requestedDays > parseInt(maxDays)) {
            warningDiv.style.display = 'block';
            warningText.textContent = `Warning: You are requesting ${requestedDays} days, but the maximum allowed for this leave type is ${maxDays} days. This will require special HR approval.`;
        } else {
            warningDiv.style.display = 'none';
        }
    }
}

function checkNoticeRequirement() {
    const leaveTypeSelect = document.getElementById('leave_type');
    const selectedOption = leaveTypeSelect.options[leaveTypeSelect.selectedIndex];
    const startDate = new Date(document.getElementById('start_date').value);
    const today = new Date();
    
    if (selectedOption.value && startDate) {
        const noticeDays = parseInt(selectedOption.getAttribute('data-notice-days'));
        const daysFromNow = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
        
        const warningDiv = document.getElementById('notice_warning');
        const warningText = document.getElementById('notice_warning_text');
        
        if (noticeDays > 0 && daysFromNow < noticeDays) {
            warningDiv.style.display = 'block';
            warningText.textContent = `Warning: This leave type requires ${noticeDays} days advance notice, but you are only giving ${daysFromNow} days notice. This will require special HR approval.`;
        } else if (document.getElementById('total_days').value.includes('Warning')) {
            // Keep existing warning about exceeding max days
        } else {
            warningDiv.style.display = 'none';
        }
    }
}

document.getElementById('start_date').addEventListener('change', calculateDays);
document.getElementById('end_date').addEventListener('change', calculateDays);

// Update end date minimum when start date changes
document.getElementById('start_date').addEventListener('change', function() {
    document.getElementById('end_date').min = this.value;
});

// Set initial minimum date to today
document.getElementById('start_date').min = new Date().toISOString().split('T')[0];

// Form validation
document.getElementById('leaveForm').addEventListener('submit', function(e) {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    
    if (endDate < startDate) {
        e.preventDefault();
        alert('End date cannot be before start date');
        return false;
    }
    
    // Check if there are warnings
    const warningDiv = document.getElementById('notice_warning');
    if (warningDiv.style.display === 'block') {
        e.preventDefault();
        if (confirm('There are policy warnings for this request. Do you want to proceed anyway?\n\nNote: This will require special HR approval.')) {
            this.submit();
        }
        return false;
    }
});
</script>
{% endblock %}